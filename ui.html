<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 12px;
      padding: 12px;
      margin: 0;
      background: #ffffff;
      color: #333333;
      position: relative;
      min-height: 100vh;
      box-sizing: border-box;
    }
    
    .app-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 10px;
      padding: 16px 0;
    }
    
    .app-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .app-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .app-name {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 18px;
      font-weight: 700;
      color: #00433D;
      letter-spacing: -0.02em;
    }
    
    .logo {
      text-align: right;
      margin: 20px 0 0 0;
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }
    
    .logo-svg {
      height: 13px;
      width: 56px;
      max-width: 56px;
    }
    
    .instructions {
      text-align: center;
      margin: 0 0 16px 0;
      font-family: 'DM Sans', sans-serif;
      font-weight: 400;
      color: #00433D;
      line-height: 1.4;
    }
    
    .instructions p {
      margin: 3px 0;
      font-size: 11px;
    }
    
    h3 {
      margin: 0 0 16px 0;
      font-size: 14px;
      font-weight: 600;
      color: #000000;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    button {
      width: 100%;
      height: 32px;
      margin-bottom: 6px;
      border: 1px solid #e5e5e5;
      border-radius: 16px;
      background: #ffffff;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }
    
    button:hover {
      background: #f8f8f8;
      border-color: #d0d0d0;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    button:active {
      background: #f0f0f0;
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f5f5f5;
      transform: none;
      box-shadow: none;
    }
    
    .loading {
      position: relative;
    }
    
    .loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      right: 12px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    #importBtn {
      background: #00433D;
      color: white;
      border-color: #00433D;
      font-family: 'Bricolage Grotesque', sans-serif;
      font-weight: 700;
      font-size: 14px;
      padding: 16px 0;
    }
    
    #importBtn:hover {
      background: #003329;
      border-color: #003329;
    }
    
    .file-drop-zone {
      border: 2px dashed #ccc;
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      background: #fafafa;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 12px;
    }
    
    .file-drop-zone:hover {
      border-color: #00433D;
      background: #f6f8fa;
    }
    
    .file-drop-zone.dragover {
      border-color: #00433D;
      background: #e7f3ff;
    }
    
    #fileInput {
      display: none;
    }
    
    .file-list {
      max-height: 120px;
      overflow-y: auto;
      border: 1px solid #e1e5e9;
      border-radius: 16px;
      background: white;
      margin: 8px 0;
    }
    
    .file-item {
      padding: 8px 12px;
      border-bottom: 1px solid #f1f3f4;
      font-size: 11px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .file-item:last-child {
      border-bottom: none;
    }
    
    #status {
      margin-top: 12px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 16px;
      font-size: 11px;
      border-left: 4px solid #e9ecef;
      line-height: 1.4;
      transition: all 0.3s ease;
    }
    
    .status-content {
      margin-bottom: 12px;
    }
    
    .error {
      color: #d73027;
      background: #fff5f5;
      border-left-color: #fc8181;
    }
    
    .success {
      color: #1a7431;
      background: #f0fff4;
      border-left-color: #68d391;
    }
    
    .info {
      color: #8E4EC6;
      background: #ebf8ff;
      border-left-color: #63b3ed;
    }
    
    .warning {
      color: #d69e2e;
      background: #fffbeb;
      border-left-color: #f6e05e;
    }
    
    .progress-bar {
      width: 100%;
      height: 4px;
      background: #e9ecef;
      border-radius: 2px;
      margin-top: 6px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: #00433D;
      border-radius: 2px;
      transition: width 0.3s ease;
      width: 0%;
    }
    
    .stats {
      display: flex;
      gap: 16px;
      margin: 12px 0;
      font-size: 10px;
      color: #666;
      justify-content: center;
    }
    
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    
    .stat-value {
      font-weight: 600;
      font-size: 12px;
      color: #333;
    }
    
    .tooltip {
      position: relative;
      cursor: help;
    }
    
    .tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 1000;
    }
    
    .tooltip:hover::after {
      opacity: 1;
    }
    
    .frame-feedback {
      margin: 12px 0;
      padding: 12px 16px;
      background: #F5FBF5;
      border-radius: 12px;
      font-size: 12px;
      border-left: 4px solid #E9F6E9;
      line-height: 1.4;
      transition: all 0.3s ease;
    }
    
    .frame-feedback .feedback-content {
      color: #00433D;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="app-header">
    <div class="app-icon">
      <svg width="24" height="24" viewBox="0 0 300 300" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g clip-path="url(#clip0_2305_2891)">
          <path d="M257.878 0H42.1222C18.8588 0 0 18.8588 0 42.1222V257.878C0 281.141 18.8588 300 42.1222 300H257.878C281.141 300 300 281.141 300 257.878V42.1222C300 18.8588 281.141 0 257.878 0Z" fill="#00433D"/>
          <path d="M167.71 37.4305H132.285V262.567H167.71V37.4305Z" fill="#D8FF4F"/>
        </g>
        <defs>
          <clipPath id="clip0_2305_2891">
            <rect width="300" height="300" fill="white"/>
          </clipPath>
        </defs>
      </svg>
    </div>
    <div class="app-name">Asset.to.Design</div>
  </div>
  
  <div class="instructions">
    <p>1- Select design to apply assets</p>
    <p>2- Drop images â†’ click "Import Images to Layers"</p>
  </div>
  
  <!-- Frame Selection Feedback -->
  <div id="frameFeedback" class="frame-feedback">
    <div class="feedback-content">
      <span id="frameFeedbackText">Select a frame and drop images to start importing.</span>
    </div>
  </div>
  
  <!-- Step 1: Choose Images -->
  <div class="file-drop-zone" id="dropZone">
    <p>Drop image files here or click to browse</p>
    <small>Supported: PNG, JPG, SVG</small>
  </div>
  <input type="file" id="fileInput" multiple accept=".png,.jpg,.jpeg,.svg">
  <div id="fileList" class="file-list" style="display: none;"></div>
  
  <!-- Step 2: Import -->
  <button id="importBtn" class="primary" disabled data-tooltip="Import selected images to matching named layers">
    Import Images to Layers
  </button>
  
  <div id="status" class="info" style="display: none;">
    <div class="status-content">
      Select a frame and drop images to start importing.
    </div>
    
    <div class="stats" id="stats" style="display: none;">
      <div class="stat-item">
        <div class="stat-value" id="totalCount">0</div>
        <div>Total</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="mappedCount">0</div>
        <div>Mapped</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="skippedCount">0</div>
        <div>Skipped</div>
      </div>
    </div>
  </div>
  
  <div class="progress-bar" id="progressBar" style="display: none;">
    <div class="progress-fill" id="progressFill"></div>
  </div>
  
  <div class="logo">
    <svg width="56" height="13" viewBox="0 0 352 80" fill="none" xmlns="http://www.w3.org/2000/svg" class="logo-svg">
      <g clip-path="url(#clip0_8905_69806)">
        <path d="M79.7073 18.3195V61.7537H89.1341V18.3195H79.7073Z" fill="#00433D"/>
        <path d="M119.693 17.8268C112.483 17.8268 107.4 20.9415 104.615 26.8415L103.468 18.3195H95.6829V61.7537H105.351V40.2805C105.351 26.8488 109.659 27.2415 119.693 27.2512C120.102 27.2512 121.332 27.3049 121.332 27.3049V17.8268H119.693Z" fill="#00433D"/>
        <path d="M149.929 17.0073C143.046 17.0073 137.393 20.3683 134.524 25.4488L133.541 18.3195H125.756V79.8512H135.507V55.6878C138.459 60.1951 143.62 62.9829 149.849 62.9829C161.402 62.9829 169.517 53.4756 169.517 39.7903C169.517 26.1049 161.402 17.0073 149.929 17.0073ZM147.717 54.7049C137.249 54.7049 135.507 52.8024 135.507 39.5439C135.507 26.2854 138.627 25.3073 147.637 25.3073C157.89 25.3073 159.6 27.0098 159.6 39.7903C159.6 52.5707 157.89 54.7049 147.717 54.7049Z" fill="#00433D"/>
        <path d="M197.217 17.0097C192.954 17.0097 189.066 18.2146 186.146 20.4244V27.4829C187.259 26.3488 189.598 25.3073 192.805 25.3073C200.271 25.3073 202.795 27.5098 202.871 38.0219V61.7585H212.541V32.8439C212.541 23.0927 206.478 17.0073 197.217 17.0073V17.0097ZM183.622 37.4951H183.615V22.8463H183.612V0.148773H173.941V61.761H183.612V41.6463C183.612 40.2024 183.602 38.8122 183.622 37.4951Z" fill="#00433D"/>
        <path d="M239.256 17.0073C226.554 17.0073 216.966 25.4488 216.966 39.6268C216.966 53.0658 225.161 62.9829 239.256 62.9829C252.205 62.9829 261.466 54.2951 261.466 39.6268C261.466 26.8415 253.271 17.0073 239.256 17.0073ZM239.256 54.7049C229.302 54.7049 226.8 53.6317 226.8 39.6268C226.8 25.6219 229.334 25.3049 239.256 25.3049C249.178 25.3049 251.632 26.3219 251.632 39.6268C251.632 52.9317 249.229 54.7049 239.256 54.7049Z" fill="#00433D"/>
        <path d="M22.0561 8.47561H30.7878V0.314636H21.4024C12.4244 0.314636 7.60976 4.72195 7.60976 12.8829V18.3195H0.019516V25.9927H7.60976V61.7293H17.2415V25.9927H29.8098V18.3195H17.2415V13.5366C17.2415 10.2707 18.9537 8.47561 22.0561 8.47561Z" fill="#00433D"/>
        <path d="M89.1341 0.290253H79.7244V9.94391H89.1341V0.290253Z" fill="#00433D"/>
        <path d="M289.163 17.0098C282.69 17.0098 277.2 20.2049 274.495 24.7122L273.676 18.3195H265.89V61.7537H275.561V37.0025C275.561 25.2634 281 25.3073 285.483 25.3073C291.544 25.3073 294.82 27.1537 294.82 37.4951V61.7537H304.488V32.9903C304.488 23.2366 298.424 17.0098 289.163 17.0098Z" fill="#00433D"/>
        <path d="M318.583 42.0024H351.2V39.7073C350.954 25.6122 342.759 17.0073 330.466 17.0073C318.173 17.0073 308.912 25.8585 308.912 40.2C308.912 53.4756 318.01 62.9829 331.285 62.9829C341.529 62.9829 348.822 57.3268 351.037 47.9854H341.612C340.583 53.5366 337.893 54.7024 330.578 54.7024C327.593 54.7024 325.3 54.5659 323.561 53.9781H323.559C320.063 52.8 318.79 49.7707 318.583 42.122C318.583 42.1146 318.583 42.1098 318.583 42.1049V42.0024ZM318.685 35.3049C319.278 25.6 323.22 25.6 329.3 25.3195C329.424 25.3146 330.198 25.3 330.466 25.3073C337.107 25.5122 340.729 25.9122 341.202 35.3049H318.685Z" fill="#00433D"/>
        <path d="M30.8049 49.6829C30.8878 39.5293 40.9585 37.4 49.3951 36.4171C55.9463 35.6805 61.1024 35.4268 60.861 31.9951C60.5488 27.5683 57.9171 25.4073 51.9341 25.3073C46.1488 25.2098 42.5854 25.9659 41.5341 32.5683H31.7902C32.6902 23.3976 40.8805 17.0098 52.1 17.0098C63.3195 17.0098 70.2805 23.3976 70.2805 32.6512V52.3049C70.2805 53.5342 70.9366 54.1878 72.4098 54.1878H74.7854V61.722H70.2C65.778 61.722 63.0756 59.9195 62.339 56.6439C62.1756 56.2342 62.0122 55.661 61.9293 55.1707C59.3902 59.839 54.6415 62.9829 47.2707 62.9829C37.2805 62.9829 30.7293 57.7903 30.8098 49.6829H30.8049ZM61.3293 45.4342C61.4976 42.8854 61.4902 39.2268 61.4902 39.2268C59.8512 41.7659 55.0439 42.4781 50.4561 43.0512C45.0512 43.7073 40.5463 44.4439 40.5463 49.0293C40.5463 52.7951 43.4805 54.8732 49.2268 54.7049C55.9927 54.5073 60.7024 54.861 61.3268 45.4342H61.3293Z" fill="#00433D"/>
      </g>
      <defs>
        <clipPath id="clip0_8905_69806">
          <rect width="351.22" height="80" fill="white"/>
        </clipPath>
      </defs>
    </svg>
  </div>
  
  <script>
    const importBtn = document.getElementById('importBtn');
    const status = document.getElementById('status');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const stats = document.getElementById('stats');
    const totalCount = document.getElementById('totalCount');
    const mappedCount = document.getElementById('mappedCount');
    const skippedCount = document.getElementById('skippedCount');
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const frameFeedback = document.getElementById('frameFeedback');
    const frameFeedbackText = document.getElementById('frameFeedbackText');
    
    let isProcessing = false;
    let selectedFiles = [];
    
    // Initialize import button as disabled until files are selected
    importBtn.disabled = true;
    
    // Initialize stats as hidden
    stats.style.display = 'none';
    
    importBtn.onclick = handleImport;
    
    // File selection handlers
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', handleDragOver);
    dropZone.addEventListener('drop', handleDrop);
    fileInput.addEventListener('change', handleFileSelect);
    
    // Function to update frame feedback
    function updateFrameFeedback(message, show = true) {
      if (show) {
        frameFeedbackText.textContent = message;
        frameFeedback.style.display = 'block';
      } else {
        frameFeedback.style.display = 'none';
      }
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      dropZone.classList.add('dragover');
    }
    
    function handleDrop(e) {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    }
    
    function handleFileSelect(e) {
      handleFiles(e.target.files);
    }
    
    async function handleFiles(files) {
      selectedFiles = [];
      
      for (let file of files) {
        if (file.type.startsWith('image/')) {
          try {
            const arrayBuffer = await file.arrayBuffer();
            const data = Array.from(new Uint8Array(arrayBuffer));
            
            const nameWithExt = file.name;
            const lastDot = nameWithExt.lastIndexOf('.');
            const name = lastDot > 0 ? nameWithExt.substring(0, lastDot) : nameWithExt;
            const extension = lastDot > 0 ? nameWithExt.substring(lastDot + 1).toLowerCase() : '';
            
            selectedFiles.push({
              name: name.toLowerCase().trim(),
              extension,
              data,
              size: file.size,
              originalName: file.name
            });
          } catch (error) {
            console.error('Error processing file:', file.name, error);
          }
        }
      }
      
      updateFileList();
      updateImportButton();
    }
    
    function updateFileList() {
      if (selectedFiles.length === 0) {
        fileList.style.display = 'none';
        return;
      }
      
      fileList.style.display = 'block';
      fileList.innerHTML = selectedFiles.map(file => 
        `<div class="file-item">
          <span>${file.originalName}</span>
          <small>${(file.size / 1024).toFixed(1)} KB</small>
        </div>`
      ).join('');
    }
    
    function updateImportButton() {
      importBtn.disabled = selectedFiles.length === 0;
    }
    
    async function handleImport() {
      if (selectedFiles.length === 0) return;
      
      updateStatus('Importing images...', 'info');
      importBtn.disabled = true;
      
      sendMessage({
        type: 'IMPORT_IMAGES',
        imageFiles: selectedFiles
      });
    }
    
    function sendMessage(message) {
      if (isProcessing) return;
      
      setProcessing(true);
      parent.postMessage({pluginMessage: message}, '*');
    }
    
    function setProcessing(processing) {
      isProcessing = processing;
      
      // Update button states based on processing state
      importBtn.disabled = processing || selectedFiles.length === 0;
      
      if (processing) {
        importBtn.classList.add('loading');
      } else {
        importBtn.classList.remove('loading');
      }
    }
    
    function updateStatus(message, className = 'info') {
      // Update only the status content, not the entire status div
      const statusContent = status.querySelector('.status-content');
      if (statusContent) {
        statusContent.textContent = message;
      }
      status.className = className;
      status.style.display = 'block'; // Make sure status is visible when updated
    }
    
    function showProgress(show) {
      progressBar.style.display = show ? 'block' : 'none';
      if (!show) {
        progressFill.style.width = '0%';
      }
    }
    
    function updateProgress(percent) {
      progressFill.style.width = percent + '%';
    }
    
    function showStats(show) {
      stats.style.display = show ? 'flex' : 'none';
    }
    
    function updateStats(total, mapped, skipped) {
      totalCount.textContent = total || 0;
      mappedCount.textContent = mapped || 0;
      skippedCount.textContent = skipped || 0;
    }
    
    onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      setProcessing(false);
      
      switch (msg.type) {
        case 'FRAME_SELECTED':
          updateFrameFeedback(`You have selected the frame "${msg.frameName}"`);
          break;
          
        case 'NO_FRAME_SELECTED':
          updateFrameFeedback('Select a frame and drop images to start importing.');
          break;
          
        case 'IMPORT_COMPLETE':
          const result = msg.result;
          let message = `âœ“ Import complete: ${result.mapped}/${result.totalImages} images applied`;
          
          if (result.skipped > 0) {
            message += `\n${result.skipped} skipped:`;
            result.skippedDetails.forEach(item => {
              message += `\nâ€¢ ${item.filename}: ${item.reason}`;
            });
          }
          
          updateStatus(message, result.mapped > 0 ? 'success' : 'error');
          showProgress(false);
          showStats(true);
          updateStats(result.totalImages, result.mapped, result.skipped);
          importBtn.disabled = false;
          break;
          
        case 'PROGRESS':
          showProgress(true);
          updateProgress(msg.percent);
          break;
          
        case 'ERROR':
          updateStatus(`Error: ${msg.message}`, 'error');
          showProgress(false);
          importBtn.disabled = false;
          break;
      }
    };
  </script>
</body>
</html>
